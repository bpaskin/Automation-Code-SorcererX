
- name: Deploy Rails Webapp
  hosts: all
  become: yes
  vars:
    WEBAPP_PATH: "/opt/webapps/rails"
    service_webapp_repo: "{{ lookup('env', 'service_webapp_repo') }}"
    service_webapp_tag: "{{ lookup('env', 'service_webapp_tag') }}"
    db_user: "{{ lookup('env', 'db_user') }}"
    db_password: "{{ lookup('env', 'db_password') }}"
    db_name: "{{ lookup('env', 'db_name') }}"
    db_ip: "{{ lookup('env', 'db_ip') }}"

  tasks:
    - name: Notify beginning of deploy
      debug:
        msg: "Beginning deploy of {{ service_webapp_repo }} version {{ service_webapp_tag }} into {{ WEBAPP_PATH }}"

    - name: Install required packages
      apt:
        name:
          - rubygems
          - ruby-dev
          - libxml2-dev
          - libxslt-dev
          - libsqlite3-dev
          - libmysqlclient-dev
        state: present

    - name: Install bundler
      gem:
        name: bundler
        state: present
        gem_home: /usr/local
        gem_binary: /usr/local/bin/gem
        extra_gems:
          - rubygems

    - name: Enable and start apache
      service:
        name: apache2
        state: started
        enabled: yes

    - name: Create webapp directory
      file:
        path: "{{ WEBAPP_PATH }}"
        state: directory
        owner: rails
        group: rails
        mode: '0755'

    - name: Clone webapp repository
      git:
        repo: "{{ service_webapp_repo }}"
        dest: "{{ WEBAPP_PATH }}"
        update: yes

    - name: Checkout webapp tag
      git:
        repo: "{{ service_webapp_repo }}"
        dest: "{{ WEBAPP_PATH }}"
        version: "{{ service_webapp_tag }}"

    - name: Add unicorn to Gemfile
      lineinfile:
        path: "{{ WEBAPP_PATH }}/Gemfile.local"
        line: "gem 'unicorn'"

    - name: Install webapp dependencies
      command: bundle install --without development test rmagick postgresql
      args:
        chdir: "{{ WEBAPP_PATH }}"
        creates: "{{ WEBAPP_PATH }}/config/database.yml"

    - name: Generate secret key
      command: bundle exec rake generate_session_store
      args:
        chdir: "{{ WEBAPP_PATH }}"
        creates: "{{ WEBAPP_PATH }}/config/database.yml"

    - name: Configure database.yml
      template:
        src: "webapp/database.yml.erb"
        dest: "{{ WEBAPP_PATH }}/config/database.yml"
      vars:
        db_user: "{{ db_user }}"
        db_password: "{{ db_password }}"
        db_name: "{{ db_name }}"
        db_ip: "{{ db_ip }}"

    - name: Run database migrations and load default data
      command: bundle exec rake db:migrate RAILS_ENV=production && bundle exec rake redmine:load_default_data RAILS_ENV=production REDMINE_LANG=en
      args:
        chdir: "{{ WEBAPP_PATH }}"
        creates: "{{ WEBAPP_PATH }}/config/database.yml"

    - name: Create rails user
      user:
        name: rails
        comment: rails
        shell: /bin/sh
        home: "{{ WEBAPP_PATH }}"
        createhome: yes
        system: no
        groups: minimum
        append: yes

    - name: Set ownership of webapp directories
      file:
        path:
          - "{{ WEBAPP_PATH }}/files"
          - "{{ WEBAPP_PATH }}/log"
          - "{{ WEBAPP_PATH }}/tmp"
          - "{{ WEBAPP_PATH }}/public"
        owner: rails
        group: rails
        mode: '0755'

    - name: Configure unicorn
      upstart:
        job: unicorn
        description: unicorn app server
        command: start-stop-daemon --start -c rails -d {{ WEBAPP_PATH }} --exec /usr/local/bin/bundle -- exec unicorn_rails -E production
        start_on_boot: yes
        start_on_failure: yes
        start_on_restart: yes
        start_on_unknown: yes
        start_on_unknown_failure: yes
        start_on_unknown_restart: yes
        start_on_unknown_unknown: yes
        start_on_unknown_unknown_failure: yes
        start_on_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_ansible_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_ansible_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_failure: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_restart: yes
        start_on_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown_unknown: yes
        start_on_unknown_unknown_unknown_unknown_ansible_unknown_unknown_unknown_unknown_unknown_