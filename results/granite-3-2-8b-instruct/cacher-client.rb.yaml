
- name: Remove proxy from /etc/apt/apt.conf
  hosts: all
  become: true
  tasks:
    - name: Remove proxy from /etc/apt/apt.conf
      command: sed --in-place '/^Acquire::http::Proxy/d' /etc/apt/apt.conf
      when: grep Acquire::http::Proxy /etc/apt/apt.conf

- name: Configure apt cacher client
  hosts: all
  become: true
  vars:
    cacher_ipaddress: "{{ lookup('lookup', 'interface_ipaddress', servers[0], servers[0].apt.cacher_interface) }}"
    port: "{{ servers[0].apt.cacher_port }}"
    proxy_ssl: "{{ servers[0].apt.cacher_ssl_support }}"
    bypass: "{{ node.apt.cache_bypass }}"
  tasks:
    - name: Create or update /etc/apt/apt.conf.d/01proxy
      template:
        src: 01proxy.erb
        dest: /etc/apt/apt.conf.d/01proxy
        owner: root
        group: root
        mode: 00644
        variables:
          proxy: "{{ cacher_ipaddress }}"
          port: "{{ port }}"
          proxy_ssl: "{{ proxy_ssl }}"
          bypass: "{{ bypass }}"
      notify:
        - Run apt-get update
      when: servers.length > 0

    - name: Delete /etc/apt/apt.conf.d/01proxy
      file:
        path: /etc/apt/apt.conf.d/01proxy
        state: absent
      when: servers.length == 0

- name: Include apt default recipe
  include_role:
    name: apt
    tasks: default

[OUTPUT]
- name: Remove proxy from /etc/apt/apt.conf
  hosts: all
  become: true
  tasks:
    - name: Remove proxy from /etc/apt/apt.conf
      command: sed --in-place '/^Acquire::http::Proxy/d' /etc/apt/apt.conf
      when: grep Acquire::http::Proxy /etc/apt/apt.conf

- name: Configure apt cacher client
  hosts: all
  become: true
  vars:
    cacher_ipaddress: "{{ lookup('lookup', 'interface_ipaddress', servers[0], servers[0].apt.cacher_interface) }}"
    port: "{{ servers[0].apt.cacher_port }}"
    proxy_ssl: "{{ servers[0].apt.cacher_ssl_support }}"
    bypass: "{{ node.apt.cache_bypass }}"
  tasks:
    - name: Create or update /etc/apt/apt.conf.d/01proxy
      template:
        src: 01proxy.erb
        dest: /etc/apt/apt.conf.d/01proxy
        owner: root
        group: root
        mode: 00644
        variables:
          proxy: "{{ cacher_ipaddress }}"
          port: "{{ port }}"
          proxy_ssl: "{{ proxy_ssl }}"
          bypass: "{{ bypass }}"
      notify:
        - Run apt-get update
      when: servers.length > 0

    - name: Delete /etc/apt/apt.conf.d/01proxy
      file:
        path: /etc/apt/apt.conf.d/01proxy
        state: absent
      when: servers.length == 0

- name: Include apt default recipe
  include_role:
    name: apt
    tasks: default